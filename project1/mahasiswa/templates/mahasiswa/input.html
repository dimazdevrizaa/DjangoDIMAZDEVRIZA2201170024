<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Mahasiswa</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
    <div class="container py-5">
        <h1 class="page-header text-center mb-5">Sistem Manajemen Data Mahasiswa</h1>

        {% if pesan %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>{{ pesan }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card mb-4 shadow-lg">
                    <div class="card-header gradient-header py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person-plus-fill me-2"></i>Form Input Mahasiswa
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="post" novalidate>
                            {% csrf_token %}
                            <!-- Form fields -->
                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.nama.id_for_label }}">
                                    <i class="bi bi-person me-2"></i>Nama:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.nama }}
                                    {% if form.nama.errors %}
                                    <div class="text-danger small mt-1">{{ form.nama.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.npm.id_for_label }}">
                                    <i class="bi bi-hash me-2"></i>NPM:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.npm }}
                                    {% if form.npm.errors %}
                                    <div class="text-danger small mt-1">{{ form.npm.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.email.id_for_label }}">
                                    <i class="bi bi-envelope me-2"></i>Email:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                    <div class="text-danger small mt-1">{{ form.email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-4 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.no_hp.id_for_label }}">
                                    <i class="bi bi-phone me-2"></i>No. HP:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.no_hp }}
                                    {% if form.no_hp.errors %}
                                    <div class="text-danger small mt-1">{{ form.no_hp.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-start">
                                <label class="col-sm-2 form-row-label" for="{{ form.jurusan.id_for_label }}">
                                    <i class="bi bi-building me-2"></i>Jurusan:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.jurusan }}
                                    {% if form.jurusan.errors %}
                                    <div class="text-danger small mt-1">{{ form.jurusan.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-4 align-items-start">
                                <label class="col-sm-2 form-row-label" for="{{ form.alamat.id_for_label }}">
                                    <i class="bi bi-geo-alt me-2"></i>Alamat:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.alamat }}
                                    {% if form.alamat.errors %}
                                    <div class="text-danger small mt-1">{{ form.alamat.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="offset-sm-2 col-sm-10">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Simpan Data
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card shadow-lg">
                    <div class="card-header gradient-header py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-table me-2"></i>Daftar Mahasiswa
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Search and Filter -->
                        <form method="get" class="row g-3 mb-4">
                            <div class="col-md-5">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="bi bi-search text-secondary"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" name="q"
                                        placeholder="Cari Nama atau NPM..." value="{{ search_query }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-white"><i
                                            class="bi bi-funnel text-secondary"></i></span>
                                    <select class="form-select border-start-0" name="jurusan">
                                        <option value="">Semua Jurusan</option>
                                        <option value="Teknologi Informasi" {% if jurusan_filter == 'Teknologi Informasi' %}selected{% endif %}>Teknologi Informasi</option>
                                        <option value="Sains Data" {% if jurusan_filter == 'Sains Data' %}selected{% endif %}>Sains Data</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3 d-flex gap-2">
                                <button type="submit" class="btn btn-primary shadow-sm flex-grow-1">
                                    <i class="bi bi-search me-1"></i>Filter
                                </button>
                                <a href="{% url 'input_mahasiswa' %}" class="btn btn-outline-secondary shadow-sm"
                                    title="Reset Filter">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </a>
                            </div>
                        </form>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-semibold">No</th>
                                        <th class="fw-semibold">Nama</th>
                                        <th class="fw-semibold">NPM</th>
                                        <th class="fw-semibold">No. HP</th>
                                        <th class="fw-semibold">Jurusan</th>
                                        <th class="fw-semibold">Alamat</th>
                                        <th class="fw-semibold">Email</th>
                                        <th class="fw-semibold text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mhs in mahasiswa %}
                                    <tr data-id="{{ mhs.id }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td class="nama">{{ mhs.nama }}</td>
                                        <td class="npm">{{ mhs.npm }}</td>
                                        <td class="no_hp">{{ mhs.no_hp }}</td>
                                        <td class="jurusan">{{ mhs.jurusan }}</td>
                                        <td class="alamat">{{ mhs.alamat }}</td>
                                        <td class="email">{{ mhs.email }}</td>
                                        <td class="aksi text-center">
                                            <button type="button" class="btn btn-warning btn-sm edit-btn"
                                                data-id="{{ mhs.id }}"
                                                data-update-url="{% url 'mahasiswa_update' mhs.id %}">
                                                <i class="bi bi-pencil-square me-1"></i>Edit
                                            </button>
                                            <button type="button" class="btn btn-danger delete-btn ms-1"
                                                data-id="{{ mhs.id }}"
                                                data-delete-url="{% url 'mahasiswa_delete' mhs.id %}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4 text-muted">
                                            <i class="bi bi-inbox-fill me-2"></i>Tidak ada data mahasiswa.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Your existing script remains unchanged -->
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let c of cookies) {
                    const cookie = c.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function updateRowNumbers() {
            const tbody = document.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const numberCell = row.querySelector('th');
                if (numberCell) {
                    numberCell.textContent = index + 1;
                }
            });
        }

        document.addEventListener('click', function (e) {
            // EDIT button
            if (e.target.closest('.edit-btn')) {  // Change from matches() to closest()
                const btn = e.target.closest('.edit-btn');  // Get the button even if icon was clicked
                const row = btn.closest('tr');
                const id = btn.dataset.id;
                const namaCell = row.querySelector('.nama');
                const npmCell = row.querySelector('.npm');
                const emailCell = row.querySelector('.email');
                const noHpCell = row.querySelector('.no_hp');
                const jurusanCell = row.querySelector('.jurusan');
                const alamatCell = row.querySelector('.alamat');

                const editing = btn.dataset.editing === 'true';
                if (!editing) {
                    btn.dataset.editing = 'true';
                    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save';  // Update button content with icon
                    let cancel = row.querySelector('.cancel-btn');
                    if (!cancel) {
                        cancel = document.createElement('button');
                        cancel.type = 'button';
                        cancel.className = 'btn btn-sm btn-secondary ms-1 cancel-btn';
                        cancel.textContent = 'Cancel';
                        row.querySelector('.aksi').appendChild(cancel);
                    }

                    namaCell.dataset.old = namaCell.textContent.trim();
                    npmCell.dataset.old = npmCell.textContent.trim();
                    emailCell.dataset.old = emailCell.textContent.trim();
                    if (noHpCell) noHpCell.dataset.old = noHpCell.textContent.trim();
                    jurusanCell.dataset.old = jurusanCell.textContent.trim();
                    alamatCell.dataset.old = alamatCell.textContent.trim();

                    namaCell.innerHTML = `<input class="form-control form-control-sm" value="${namaCell.dataset.old}">`;
                    npmCell.innerHTML = `<input class="form-control form-control-sm" value="${npmCell.dataset.old}">`;
                    emailCell.innerHTML = `<input class="form-control form-control-sm" value="${emailCell.dataset.old}">`;
                    if (noHpCell) noHpCell.innerHTML = `<input class="form-control form-control-sm" value="${noHpCell.dataset.old}">`;
                    jurusanCell.innerHTML = `<select class="form-control form-control-sm">
                <option value="">Pilih Jurusan</option>
                <option value="Teknologi Informasi" ${jurusanCell.dataset.old === 'Teknologi Informasi' ? 'selected' : ''}>Teknologi Informasi</option>
                <option value="Sains Data" ${jurusanCell.dataset.old === 'Sains Data' ? 'selected' : ''}>Sains Data</option>
            </select>`;
                    alamatCell.innerHTML = `<textarea class="form-control form-control-sm" rows="2">${alamatCell.dataset.old}</textarea>`;
                    return;
                }

                // Save flow
                const newNama = namaCell.querySelector('input').value.trim();
                const newNpm = npmCell.querySelector('input').value.trim();
                const newEmail = emailCell.querySelector('input').value.trim();
                const newNoHp = noHpCell ? noHpCell.querySelector('input').value.trim() : '';
                const newJurusan = jurusanCell.querySelector('select') ? jurusanCell.querySelector('select').value.trim() : jurusanCell.querySelector('input').value.trim();
                const newAlamat = alamatCell.querySelector('textarea').value.trim();

                const updateUrl = btn.dataset.updateUrl;
                fetch(updateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ nama: newNama, npm: newNpm, email: newEmail, no_hp: newNoHp, jurusan: newJurusan, alamat: newAlamat })
                })
                    .then(r => r.json())
                    .then(json => {
                        if (json.success) {
                            namaCell.textContent = newNama;
                            npmCell.textContent = newNpm;
                            emailCell.textContent = newEmail;
                            if (noHpCell) noHpCell.textContent = newNoHp;
                            if (jurusanCell) jurusanCell.textContent = newJurusan;
                            if (alamatCell) alamatCell.textContent = newAlamat;
                            btn.dataset.editing = 'false';
                            btn.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Edit';  // Reset button content
                            const cancelBtn = row.querySelector('.cancel-btn');
                            if (cancelBtn) cancelBtn.remove();
                        } else {
                            alert(json.error || 'Gagal menyimpan perubahan.');
                        }
                    })
                    .catch(() => alert('Terjadi kesalahan saat menyimpan.'));
            }

            // CANCEL button
            if (e.target.matches('.cancel-btn')) {
                const row = e.target.closest('tr');
                const btn = row.querySelector('.edit-btn');
                const namaCell = row.querySelector('.nama');
                const npmCell = row.querySelector('.npm');
                const emailCell = row.querySelector('.email');
                const noHpCell = row.querySelector('.no_hp');
                const jurusanCell = row.querySelector('.jurusan');
                const alamatCell = row.querySelector('.alamat');

                namaCell.textContent = namaCell.dataset.old || namaCell.textContent;
                npmCell.textContent = npmCell.dataset.old || npmCell.textContent;
                emailCell.textContent = emailCell.dataset.old || emailCell.textContent;
                if (noHpCell) noHpCell.textContent = noHpCell.dataset.old || noHpCell.textContent;
                jurusanCell.textContent = jurusanCell.dataset.old || jurusanCell.textContent;
                alamatCell.textContent = alamatCell.dataset.old || alamatCell.textContent;

                btn.dataset.editing = 'false';
                btn.textContent = 'Edit';
                e.target.remove();
            }

            // DELETE button
            if (e.target.closest('.delete-btn')) {  // Change from matches() to closest()
                const btn = e.target.closest('.delete-btn');  // Get the button even if icon was clicked
                const id = btn.dataset.id;
                const row = btn.closest('tr');
                if (!confirm('Hapus data ini?')) return;

                const deleteUrl = btn.dataset.deleteUrl;
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                    .then(r => r.json())
                    .then(json => {
                        if (json.success) {
                            row.remove();
                            updateRowNumbers();
                            // Add this to prevent the duplicate issue on refresh
                            window.location.href = window.location.pathname;  // Redirect to same page
                        } else {
                            alert(json.error || 'Gagal menghapus data.');
                        }
                    })
                    .catch(() => alert('Terjadi kesalahan saat menghapus.'));
            }
        });
    </script>
</body>

</html>