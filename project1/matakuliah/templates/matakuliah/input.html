<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Mata Kuliah</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .page-header {
            color: white;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 2rem;
        }

        .card {
            background: white;
            border: none;
            border-radius: 15px;
        }

        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .gradient-header .card-title {
            color: white;
            font-weight: 600;
        }

        .gradient-header i {
            color: white;
        }

        .form-row-label {
            text-align: left;
            font-weight: 500;
            color: #333;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background-color: #667eea;
            border-color: #667eea;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #764ba2;
            border-color: #764ba2;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }

        .alert-success {
            background-color: rgba(23, 162, 184, 0.1);
            border-color: #17a2b8;
            color: #0c5460;
        }

        .text-danger {
            color: #dc3545;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .page-header {
                font-size: 1.5rem;
            }

            .form-row-label {
                text-align: left;
                margin-bottom: 0.5rem;
            }

            .col-sm-2,
            .col-sm-10 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <h1 class="page-header text-center mb-5">Sistem Manajemen Data Mata Kuliah</h1>

        <!-- Django Messages Display -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if "success" in message.tags %}
                        <i class="bi bi-check-circle-fill me-2"></i>
                    {% elif "danger" in message.tags %}
                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                    {% elif "warning" in message.tags %}
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {% elif "info" in message.tags %}
                        <i class="bi bi-info-circle-fill me-2"></i>
                    {% endif %}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if pesan %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>{{ pesan }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card mb-4 shadow-lg">
                    <div class="card-header gradient-header py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-book-fill me-2"></i>Form Input Mata Kuliah
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="post" novalidate>
                            {% csrf_token %}
                            <!-- Form fields -->
                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.nama_mk.id_for_label }}">
                                    <i class="bi bi-book me-2"></i>Nama MK:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.nama_mk }}
                                    {% if form.nama_mk.errors %}
                                    <div class="text-danger small mt-1">{{ form.nama_mk.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.kode_mk.id_for_label }}">
                                    <i class="bi bi-hash me-2"></i>Kode MK:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.kode_mk }}
                                    {% if form.kode_mk.errors %}
                                    <div class="text-danger small mt-1">{{ form.kode_mk.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.sks.id_for_label }}">
                                    <i class="bi bi-star me-2"></i>SKS:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.sks }}
                                    {% if form.sks.errors %}
                                    <div class="text-danger small mt-1">{{ form.sks.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <label class="col-sm-2 form-row-label" for="{{ form.semester.id_for_label }}">
                                    <i class="bi bi-calendar me-2"></i>Semester:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.semester }}
                                    {% if form.semester.errors %}
                                    <div class="text-danger small mt-1">{{ form.semester.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-3 align-items-start">
                                <label class="col-sm-2 form-row-label" for="{{ form.dosen_mk.id_for_label }}">
                                    <i class="bi bi-person-badge me-2"></i>Dosen:
                                </label>
                                <div class="col-sm-10">
                                    {{ form.dosen_mk }}
                                    {% if form.dosen_mk.errors %}
                                    <div class="text-danger small mt-1">{{ form.dosen_mk.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row mb-4 align-items-start">
                                <label class="col-sm-2 form-row-label">
                                    <i class="bi bi-people me-2"></i>Mahasiswa:
                                </label>
                                <div class="col-sm-10">
                                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
                                        {{ form.mhs_mk }}
                                    </div>
                                    {% if form.mhs_mk.errors %}
                                    <div class="text-danger small mt-1">{{ form.mhs_mk.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="offset-sm-2 col-sm-10 d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Simpan Data
                                    </button>
                                    <a href="{% url 'home' %}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left me-2"></i>Kembali
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card shadow-lg">
                    <div class="card-header gradient-header py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-table me-2"></i>Daftar Mata Kuliah
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Search -->
                        <form method="get" class="row g-3 mb-4">
                            <div class="col-md-8">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="bi bi-search text-secondary"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" name="q"
                                        placeholder="Cari Nama MK atau Kode MK..." value="{{ search_query }}">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex gap-2">
                                <button type="submit" class="btn btn-primary shadow-sm flex-grow-1">
                                    <i class="bi bi-search me-1"></i>Cari
                                </button>
                                <a href="{% url 'input_matakuliah' %}" class="btn btn-outline-secondary shadow-sm"
                                    title="Reset Filter">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </a>
                            </div>
                        </form>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-semibold">No</th>
                                        <th class="fw-semibold">Nama MK</th>
                                        <th class="fw-semibold">Kode MK</th>
                                        <th class="fw-semibold">SKS</th>
                                        <th class="fw-semibold">Semester</th>
                                        <th class="fw-semibold">Dosen</th>
                                        <th class="fw-semibold text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mk in matakuliah %}
                                    <tr data-id="{{ mk.id }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td class="nama_mk">{{ mk.nama_mk }}</td>
                                        <td class="kode_mk">{{ mk.kode_mk }}</td>
                                        <td class="sks">{{ mk.sks }}</td>
                                        <td class="semester">{{ mk.semester }}</td>
                                        <td class="dosen_mk">{{ mk.dosen_mk.nama }}</td>
                                        <td class="aksi text-center">
                                            <button type="button" class="btn btn-warning btn-sm edit-btn"
                                                data-id="{{ mk.id }}"
                                                data-update-url="{% url 'matakuliah_update' mk.id %}">
                                                <i class="bi bi-pencil-square me-1"></i>Edit
                                            </button>
                                            <button type="button" class="btn btn-danger delete-btn ms-1"
                                                data-id="{{ mk.id }}"
                                                data-delete-url="{% url 'matakuliah_delete' mk.id %}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4 text-muted">
                                            <i class="bi bi-inbox-fill me-2"></i>Tidak ada data mata kuliah.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <a href="{% url 'export_matakuliah_csv' %}{% if search_query %}?q={{ search_query }}{% endif %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-file-earmark-csv me-1"></i>Export CSV
                            </a>
                            <a href="{% url 'export_matakuliah_excel' %}{% if search_query %}?q={{ search_query }}{% endif %}" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let c of cookies) {
                    const cookie = c.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function updateRowNumbers() {
            const tbody = document.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const numberCell = row.querySelector('th');
                if (numberCell) {
                    numberCell.textContent = index + 1;
                }
            });
        }

        document.addEventListener('click', function (e) {
            // EDIT button
            if (e.target.closest('.edit-btn')) {
                const btn = e.target.closest('.edit-btn');
                const row = btn.closest('tr');
                const id = btn.dataset.id;
                const namaMkCell = row.querySelector('.nama_mk');
                const kodeMkCell = row.querySelector('.kode_mk');
                const sksCell = row.querySelector('.sks');
                const semesterCell = row.querySelector('.semester');
                const dosenMkCell = row.querySelector('.dosen_mk');

                const editing = btn.dataset.editing === 'true';
                if (!editing) {
                    btn.dataset.editing = 'true';
                    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save';
                    let cancel = row.querySelector('.cancel-btn');
                    if (!cancel) {
                        cancel = document.createElement('button');
                        cancel.type = 'button';
                        cancel.className = 'btn btn-sm btn-secondary ms-1 cancel-btn';
                        cancel.textContent = 'Cancel';
                        row.querySelector('.aksi').appendChild(cancel);
                    }

                    namaMkCell.dataset.old = namaMkCell.textContent.trim();
                    kodeMkCell.dataset.old = kodeMkCell.textContent.trim();
                    sksCell.dataset.old = sksCell.textContent.trim();
                    semesterCell.dataset.old = semesterCell.textContent.trim();
                    dosenMkCell.dataset.old = dosenMkCell.textContent.trim();

                    namaMkCell.innerHTML = `<input class="form-control form-control-sm" value="${namaMkCell.dataset.old}">`;
                    kodeMkCell.innerHTML = `<input class="form-control form-control-sm" value="${kodeMkCell.dataset.old}">`;
                    sksCell.innerHTML = `<input class="form-control form-control-sm" type="number" value="${sksCell.dataset.old}">`;
                    semesterCell.innerHTML = `<input class="form-control form-control-sm" type="number" value="${semesterCell.dataset.old}">`;
                    dosenMkCell.innerHTML = `<input class="form-control form-control-sm" value="${dosenMkCell.dataset.old}" disabled>`;
                    return;
                }

                // Save flow
                const newNamaMk = namaMkCell.querySelector('input').value.trim();
                const newKodeMk = kodeMkCell.querySelector('input').value.trim();
                const newSks = sksCell.querySelector('input').value.trim();
                const newSemester = semesterCell.querySelector('input').value.trim();

                const updateUrl = btn.dataset.updateUrl;
                fetch(updateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ nama_mk: newNamaMk, kode_mk: newKodeMk, sks: newSks, semester: newSemester })
                })
                    .then(r => r.json())
                    .then(json => {
                        if (json.success) {
                            namaMkCell.textContent = newNamaMk;
                            kodeMkCell.textContent = newKodeMk;
                            sksCell.textContent = newSks;
                            semesterCell.textContent = newSemester;
                            btn.dataset.editing = 'false';
                            btn.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Edit';
                            const cancelBtn = row.querySelector('.cancel-btn');
                            if (cancelBtn) cancelBtn.remove();
                        } else {
                            alert(json.error || 'Gagal menyimpan perubahan.');
                        }
                    })
                    .catch(() => alert('Terjadi kesalahan saat menyimpan.'));
            }

            // CANCEL button
            if (e.target.matches('.cancel-btn')) {
                const row = e.target.closest('tr');
                const btn = row.querySelector('.edit-btn');
                const namaMkCell = row.querySelector('.nama_mk');
                const kodeMkCell = row.querySelector('.kode_mk');
                const sksCell = row.querySelector('.sks');
                const semesterCell = row.querySelector('.semester');
                const dosenMkCell = row.querySelector('.dosen_mk');

                namaMkCell.textContent = namaMkCell.dataset.old || namaMkCell.textContent;
                kodeMkCell.textContent = kodeMkCell.dataset.old || kodeMkCell.textContent;
                sksCell.textContent = sksCell.dataset.old || sksCell.textContent;
                semesterCell.textContent = semesterCell.dataset.old || semesterCell.textContent;
                dosenMkCell.textContent = dosenMkCell.dataset.old || dosenMkCell.textContent;

                btn.dataset.editing = 'false';
                btn.textContent = 'Edit';
                e.target.remove();
            }

            // DELETE button
            if (e.target.closest('.delete-btn')) {
                const btn = e.target.closest('.delete-btn');
                const id = btn.dataset.id;
                const row = btn.closest('tr');
                if (!confirm('Hapus data ini?')) return;

                const deleteUrl = btn.dataset.deleteUrl;
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                    .then(r => r.json())
                    .then(json => {
                        if (json.success) {
                            row.remove();
                            updateRowNumbers();
                            window.location.href = window.location.pathname;
                        } else {
                            alert(json.error || 'Gagal menghapus data.');
                        }
                    })
                    .catch(() => alert('Terjadi kesalahan saat menghapus.'));
            }
        });
    </script>
</body>

</html>
